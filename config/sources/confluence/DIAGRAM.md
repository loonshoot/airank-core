# Confluence V1 Batch Job Process Flow

```
┌─────────────────────┐
│                     │
│    Start Batch      │
│       Job           │
│                     │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐     ┌─────────────────────┐
│     Step 1:         │     │                     │
│  Fetch Spaces       │────▶│   Spaces List       │
│                     │     │                     │
│                     │     │                     │
└──────────┬──────────┘     └─────────────────────┘
           │
           ▼
┌─────────────────────┐     ┌─────────────────────┐
│     Step 2:         │     │                     │
│  Download Content   │────▶│   Content Items     │
│  (Pages, Blog Posts)│     │                     │
│                     │     │                     │
└──────────┬──────────┘     └─────────────────────┘
           │                           │
           │                           │
           │                           ▼
           │                 ┌─────────────────────┐
           │                 │                     │
           │                 │   MongoDB Stream    │
           │                 │    Collection       │
           │                 │                     │
           │                 └─────────────────────┘
           │                           ▲
           ▼                           │
┌─────────────────────┐                │
│     Step 3:         │                │
│  Process Space      │────────────────┘
│  Relationships      │
│                     │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│                     │
│  Update Job History │
│                     │
│                     │
└─────────────────────┘
```

## Confluence V1 Data Types Flow

```
┌─────────────────┐    ┌────────────────────┐    ┌────────────────────┐
│                 │    │                    │    │                    │
│  Pages          │───▶│                    │    │                    │
│                 │    │                    │    │                    │
└─────────────────┘    │                    │    │                    │
                       │    Stream          │    │    Consolidation   │
┌─────────────────┐    │    Collection      │───▶│    Jobs            │
│                 │    │                    │    │                    │
│  Blog Posts     │───▶│    (source_{id}_   │    │                    │
│                 │    │     stream)        │    │                    │
└─────────────────┘    │                    │    │                    │
                       │                    │    │                    │
┌─────────────────┐    │                    │    │                    │
│                 │    │                    │    │                    │
│  Spaces         │───▶│                    │    │                    │
│                 │    │                    │    │                    │
└─────────────────┘    └────────────────────┘    └────────────────────┘

┌─────────────────┐    
│                 │    
│  Relationships  │────┐
│                 │    │
└─────────────────┘    │
                       ▼
                    ┌────────────────────┐
                    │                    │
                    │  Relationship      │
                    │  Consolidation     │
                    │                    │
                    └────────────────────┘
```

## Incremental Update Mechanism

```
┌─────────────────┐    ┌────────────────────┐    ┌────────────────────┐
│                 │    │                    │    │                    │
│  Last Job       │───▶│  Calculate Date    │───▶│  Filter Content    │
│  Timestamp      │    │  Range             │    │  by Date Range     │
│                 │    │                    │    │                    │
└─────────────────┘    └────────────────────┘    └────────────────────┘
                                                          │
                                                          │
                                                          ▼
                                               ┌────────────────────┐
                                               │                    │
                                               │  Write Updated     │
                                               │  Content to Stream │
                                               │                    │
                                               └────────────────────┘
```

## Rate Limiting Mechanism

```
┌─────────────────┐    ┌────────────────────┐    ┌────────────────────┐
│                 │    │                    │    │                    │
│  API            │───▶│  Rate Limiter      │───▶│  API               │
│  Request        │    │  Check             │    │  Call              │
│                 │    │                    │    │                    │
└─────────────────┘    └────────────────────┘    └────────────────────┘
                              │                           │
                              │                           │
                              ▼                           ▼
                       ┌────────────────┐        ┌────────────────────┐
                       │                │        │                    │
                       │ Limit Reached  │        │  Process           │
                       │ Wait & Retry   │        │  Response          │
                       │                │        │                    │
                       └────────────────┘        └────────────────────┘
```

## Error Handling Flow

```
┌───────────────┐      ┌────────────────────┐     ┌───────────────────┐     ┌───────────────────┐
│               │      │                    │     │                   │     │                   │
│  API Call     │─────▶│  Error            │────▶│  Log Error        │────▶│  Continue         │
│  Attempt      │      │  Occurs           │     │  Details          │     │  Processing       │
│               │      │                    │     │                   │     │                   │
└───────────────┘      └────────────────────┘     └───────────────────┘     └───────────────────┘
                                │
                                │
                                ▼
                       ┌────────────────────┐
                       │                    │
                       │  Update Job        │
                       │  History           │
                       │                    │
                       └────────────────────┘
```

## Authentication Flow

```
┌───────────────┐      ┌────────────────────┐     ┌───────────────────┐
│               │      │                    │     │                   │
│  Request with │─────▶│  Token             │────▶│  Valid Token?     │
│  Auth Token   │      │  Check             │     │                   │
│               │      │                    │     │                   │
└───────────────┘      └────────────────────┘     └─────────┬─────────┘
                                                            │
                       ┌────────────────────┐     ┌─────────▼─────────┐
                       │                    │     │                   │
                       │  Return            │◀────│  No: Refresh      │
                       │  Token             │     │  Token            │
                       │                    │     │                   │
                       └────────────────────┘     └───────────────────┘
                              ▲
                              │
                     ┌────────┴─────────┐
                     │                  │
                     │  Yes: Use        │
                     │  Existing Token  │
                     │                  │
                     └──────────────────┘
``` 